<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance API Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 0.95em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #ff6b6b;
            color: white;
        }

        .btn-danger:hover {
            background: #ff5252;
        }

        .response-box {
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .response-box.success {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .response-box.error {
            border-color: #ff6b6b;
            background: #fdf4f4;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-item .label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .stat-item .value {
            font-size: 2em;
            font-weight: bold;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.online {
            background: #4caf50;
            animation: pulse 2s infinite;
        }

        .status-indicator.offline {
            background: #f44336;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert.info {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            color: #1565c0;
        }

        .alert.success {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            color: #2e7d32;
        }

        .alert.error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            color: #c62828;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #999;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            margin-bottom: -2px;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Attendance API Test Dashboard</h1>
            <p>Test the Attendance API with real requests</p>
            <div style="margin-top: 15px;">
                <span class="status-indicator online" id="statusIndicator"></span>
                <span id="statusText">Checking backend...</span>
            </div>
        </div>

        <div class="grid">
            <!-- Health Check Card -->
            <div class="card">
                <h2>üè• Health Check</h2>
                <p style="color: #666; margin-bottom: 15px;">Verify backend is running</p>
                <button class="btn-primary" onclick="healthCheck()">Check Health</button>
                <div id="healthResponse" class="response-box"></div>
            </div>

            <!-- Single Record Card -->
            <div class="card">
                <h2>üìù Record Attendance</h2>
                <p style="color: #666; margin-bottom: 15px;">Submit a single attendance record</p>
                
                <div class="form-group">
                    <label>Student ID</label>
                    <input type="text" id="singleStudentId" placeholder="12345" value="12345">
                </div>

                <div class="form-group">
                    <label>Student Name</label>
                    <input type="text" id="singleStudentName" placeholder="John Doe" value="John Doe">
                </div>

                <div class="form-group">
                    <label>Class</label>
                    <input type="text" id="singleClassName" placeholder="10-A" value="10-A">
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select id="singleStatus">
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                        <option value="late">Late</option>
                    </select>
                </div>

                <button class="btn-primary" onclick="recordSingleAttendance()">Submit Record</button>
                <div id="singleResponse" class="response-box"></div>
            </div>

            <!-- Batch Records Card -->
            <div class="card">
                <h2>üì§ Batch Records</h2>
                <p style="color: #666; margin-bottom: 15px;">Submit multiple records at once</p>

                <div class="form-group">
                    <label>Number of Records</label>
                    <input type="number" id="batchCount" placeholder="2" value="2" min="1" max="50">
                </div>

                <button class="btn-primary" onclick="generateBatchForm()">Generate Form</button>
                <div id="batchFormContainer"></div>

                <button class="btn-primary" style="margin-top: 10px;" onclick="submitBatchRecords()">Submit Batch</button>
                <div id="batchResponse" class="response-box"></div>
            </div>

            <!-- Statistics Card -->
            <div class="card">
                <h2>üìä Statistics</h2>
                <p style="color: #666; margin-bottom: 15px;">Retrieve attendance statistics</p>

                <div class="form-group">
                    <label>Date (optional)</label>
                    <input type="date" id="statsDate">
                </div>

                <div class="form-group">
                    <label>Class (optional)</label>
                    <input type="text" id="statsClass" placeholder="10-A">
                </div>

                <button class="btn-primary" onclick="getStatistics()">Get Statistics</button>
                <div id="statsResponse" class="response-box"></div>
            </div>

            <!-- Configuration Card -->
            <div class="card">
                <h2>‚öôÔ∏è Configuration</h2>
                <p style="color: #666; margin-bottom: 15px;">API Keys and Settings</p>

                <div class="form-group">
                    <label>Backend URL</label>
                    <input type="text" id="backendUrl" value="http://localhost:5000" readonly>
                </div>

                <div class="form-group">
                    <label>API Key</label>
                    <input type="text" id="apiKey" value="DETECT_HmqeWeA1wVJsK9E3oQuNPhBAHQDfbpaE" readonly>
                </div>

                <button class="btn-secondary" onclick="toggleSecretVisibility()">Show Secret Key</button>
                <div id="secretContainer" style="display: none; margin-top: 10px;">
                    <div class="form-group">
                        <label>API Secret (for reference)</label>
                        <textarea id="apiSecret" readonly style="height: 100px; font-size: 0.8em;">73a1e2bdeb0e1ac3552620c7f283fc335f3a83fe3144f22435d760e299c7e0355e5e73c009df07479fdaa130c06c65bcb2da85dbaede70b58d5fa68f28918656</textarea>
                    </div>
                </div>

                <div class="stats-grid" style="margin-top: 20px;">
                    <div class="stat-item">
                        <div class="label">Requests Made</div>
                        <div class="value" id="requestCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Successful</div>
                        <div class="value" id="successCount">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">Failed</div>
                        <div class="value" id="failureCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Rate Limits Card -->
            <div class="card">
                <h2>üö¶ Rate Limits</h2>
                <p style="color: #666; margin-bottom: 15px;">API endpoint limits</p>

                <div style="line-height: 1.8;">
                    <div>üìç <strong>Single Record:</strong> 200/hour (1 every 18s)</div>
                    <div>üìç <strong>Batch Records:</strong> 50/hour (1 every 72s)</div>
                    <div>üìç <strong>Statistics:</strong> 1000/hour</div>
                    <div>üìç <strong>Health Check:</strong> Unlimited</div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 5px;">
                    <strong>Rate Limit Status:</strong>
                    <div id="rateLimitStatus" style="margin-top: 10px; font-family: monospace; color: #667eea;">Checking...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let requestCount = 0;
        let successCount = 0;
        let failureCount = 0;

        const config = {
            backendUrl: 'http://localhost:5000',
            apiKey: 'DETECT_HmqeWeA1wVJsK9E3oQuNPhBAHQDfbpaE',
            apiSecret: '73a1e2bdeb0e1ac3552620c7f283fc335f3a83fe3144f22435d760e299c7e0355e5e73c009df07479fdaa130c06c65bcb2da85dbaede70b58d5fa68f28918656'
        };

        // Generate HMAC signature
        async function generateSignature(data) {
            const encoder = new TextEncoder();
            const dataStr = JSON.stringify(data, Object.keys(data).sort());
            const keyBuffer = encoder.encode(config.apiSecret);
            const dataBuffer = encoder.encode(dataStr);

            const signature = await crypto.subtle.sign('HMAC', 
                await crypto.subtle.importKey('raw', keyBuffer, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']),
                dataBuffer
            );

            return Array.from(new Uint8Array(signature)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Health Check
        async function healthCheck() {
            const responseBox = document.getElementById('healthResponse');
            responseBox.textContent = 'Checking...';
            responseBox.className = 'response-box';

            try {
                const response = await fetch(`${config.backendUrl}/api/attendance/health`, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': config.apiKey
                    }
                });

                requestCount++;
                const data = await response.json();

                if (response.ok) {
                    successCount++;
                    responseBox.className = 'response-box success';
                    document.getElementById('statusIndicator').className = 'status-indicator online';
                    document.getElementById('statusText').textContent = '‚úì Backend is online';
                } else {
                    failureCount++;
                    responseBox.className = 'response-box error';
                    document.getElementById('statusIndicator').className = 'status-indicator offline';
                    document.getElementById('statusText').textContent = '‚úó Backend error';
                }

                responseBox.textContent = JSON.stringify(data, null, 2);
                updateStats();
            } catch (error) {
                failureCount++;
                requestCount++;
                responseBox.className = 'response-box error';
                responseBox.textContent = `Error: ${error.message}`;
                document.getElementById('statusIndicator').className = 'status-indicator offline';
                document.getElementById('statusText').textContent = '‚úó Backend offline';
                updateStats();
            }
        }

        // Record Single Attendance
        async function recordSingleAttendance() {
            const studentId = document.getElementById('singleStudentId').value;
            const studentName = document.getElementById('singleStudentName').value;
            const className = document.getElementById('singleClassName').value;
            const status = document.getElementById('singleStatus').value;
            const responseBox = document.getElementById('singleResponse');

            if (!studentId || !studentName || !className) {
                responseBox.className = 'response-box error';
                responseBox.textContent = 'Error: Please fill in all required fields';
                return;
            }

            const data = {
                studentId,
                studentName,
                className,
                attendanceStatus: status,
                detectionResult: {
                    facesDetected: 1,
                    confidence: 0.95,
                    matchScore: 0.92,
                    position: 'front',
                    processingTimeMs: 250,
                    detectionMethod: 'haar_cascade',
                    imageQuality: 'good'
                },
                accuracy: {
                    detectionAccuracy: 0.95,
                    recognitionAccuracy: 0.92,
                    overallAccuracy: 0.93
                },
                performance: {
                    processingTimeMs: 250,
                    modelLoadTimeMs: 100,
                    totalTimeMs: 350
                },
                timestamp: new Date().toISOString()
            };

            responseBox.textContent = 'Submitting...';
            responseBox.className = 'response-box';

            try {
                const signature = await generateSignature(data);

                const response = await fetch(`${config.backendUrl}/api/attendance/record`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': config.apiKey,
                        'X-Signature': signature
                    },
                    body: JSON.stringify(data)
                });

                requestCount++;
                const result = await response.json();

                if (response.ok) {
                    successCount++;
                    responseBox.className = 'response-box success';
                } else {
                    failureCount++;
                    responseBox.className = 'response-box error';
                }

                responseBox.textContent = JSON.stringify(result, null, 2);
                updateStats();
            } catch (error) {
                failureCount++;
                requestCount++;
                responseBox.className = 'response-box error';
                responseBox.textContent = `Error: ${error.message}`;
                updateStats();
            }
        }

        // Generate Batch Form
        function generateBatchForm() {
            const count = parseInt(document.getElementById('batchCount').value) || 1;
            const container = document.getElementById('batchFormContainer');
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const html = `
                    <div style="border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 10px; border-radius: 5px;">
                        <h4 style="margin-bottom: 10px;">Record ${i + 1}</h4>
                        <div class="form-group">
                            <label>Student ID</label>
                            <input type="text" class="batch-student-id" placeholder="12345" value="${12345 + i}">
                        </div>
                        <div class="form-group">
                            <label>Student Name</label>
                            <input type="text" class="batch-student-name" placeholder="Name" value="Student ${i + 1}">
                        </div>
                        <div class="form-group">
                            <label>Class</label>
                            <input type="text" class="batch-class-name" placeholder="10-A" value="10-A">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="batch-status">
                                <option value="present">Present</option>
                                <option value="absent">Absent</option>
                                <option value="late">Late</option>
                            </select>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            }
        }

        // Submit Batch Records
        async function submitBatchRecords() {
            const responseBox = document.getElementById('batchResponse');
            const records = [];

            document.querySelectorAll('[class*="batch-"]').forEach((el, idx) => {
                if (idx % 4 === 0) {
                    const record = {
                        studentId: el.value,
                        studentName: document.querySelectorAll('.batch-student-name')[Math.floor(idx / 4)].value,
                        className: document.querySelectorAll('.batch-class-name')[Math.floor(idx / 4)].value,
                        attendanceStatus: document.querySelectorAll('.batch-status')[Math.floor(idx / 4)].value,
                        detectionResult: {
                            facesDetected: 1,
                            confidence: Math.random() * 0.1 + 0.85,
                            matchScore: Math.random() * 0.1 + 0.85,
                            position: 'front',
                            processingTimeMs: Math.floor(Math.random() * 100 + 200),
                            detectionMethod: 'haar_cascade',
                            imageQuality: 'good'
                        },
                        accuracy: {
                            detectionAccuracy: 0.95,
                            recognitionAccuracy: 0.92,
                            overallAccuracy: 0.93
                        },
                        performance: {
                            processingTimeMs: 250,
                            modelLoadTimeMs: 100,
                            totalTimeMs: 350
                        },
                        timestamp: new Date().toISOString()
                    };
                    records.push(record);
                }
            });

            if (records.length === 0) {
                responseBox.className = 'response-box error';
                responseBox.textContent = 'Error: Please generate batch form first';
                return;
            }

            const data = { attendanceRecords: records };

            responseBox.textContent = 'Submitting...';
            responseBox.className = 'response-box';

            try {
                const signature = await generateSignature(data);

                const response = await fetch(`${config.backendUrl}/api/attendance/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': config.apiKey,
                        'X-Signature': signature
                    },
                    body: JSON.stringify(data)
                });

                requestCount++;
                const result = await response.json();

                if (response.ok) {
                    successCount++;
                    responseBox.className = 'response-box success';
                } else {
                    failureCount++;
                    responseBox.className = 'response-box error';
                }

                responseBox.textContent = JSON.stringify(result, null, 2);
                updateStats();
            } catch (error) {
                failureCount++;
                requestCount++;
                responseBox.className = 'response-box error';
                responseBox.textContent = `Error: ${error.message}`;
                updateStats();
            }
        }

        // Get Statistics
        async function getStatistics() {
            const responseBox = document.getElementById('statsResponse');
            const date = document.getElementById('statsDate').value;
            const classname = document.getElementById('statsClass').value;

            let url = `${config.backendUrl}/api/attendance/stats`;
            const params = [];
            if (date) params.push(`date=${date}`);
            if (classname) params.push(`class=${classname}`);
            if (params.length) url += '?' + params.join('&');

            responseBox.textContent = 'Fetching...';
            responseBox.className = 'response-box';

            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': config.apiKey
                    }
                });

                requestCount++;
                const result = await response.json();

                if (response.ok) {
                    successCount++;
                    responseBox.className = 'response-box success';
                } else {
                    failureCount++;
                    responseBox.className = 'response-box error';
                }

                responseBox.textContent = JSON.stringify(result, null, 2);
                updateStats();
            } catch (error) {
                failureCount++;
                requestCount++;
                responseBox.className = 'response-box error';
                responseBox.textContent = `Error: ${error.message}`;
                updateStats();
            }
        }

        // Update Statistics
        function updateStats() {
            document.getElementById('requestCount').textContent = requestCount;
            document.getElementById('successCount').textContent = successCount;
            document.getElementById('failureCount').textContent = failureCount;
        }

        // Toggle Secret Visibility
        function toggleSecretVisibility() {
            const container = document.getElementById('secretContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            healthCheck();
            setInterval(healthCheck, 30000); // Check health every 30 seconds
        });
    </script>
</body>
</html>
